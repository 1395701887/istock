<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>股票离线分析</title>
    <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
    <script src="/plugs/jqgrid/jquery.jqGrid.min.js"></script>
    <script src="/plugs/jqgrid/grid.locale-cn.js"></script>
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"  crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" media="screen"  href="/plugs/jqgrid/ui.jqgrid-bootstrap.css"/>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"  crossorigin="anonymous"></script>
    <link href="//cdn.bootcss.com/limonte-sweetalert2/6.6.5/sweetalert2.min.css" rel="stylesheet">
    <script src="//cdn.bootcss.com/limonte-sweetalert2/6.6.5/sweetalert2.min.js"></script>
    <link href="https://cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/mouse0270-bootstrap-notify/3.1.7/bootstrap-notify.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/messageBox.js"></script>
    <style>
        div.header
        　　 {
            　　text-align: center;
        }
    </style>
</head>
<body style="padding: 20px 0px 0px 10px;overflow: hidden;">

<div class="row" style="margin-bottom: 10px;">
    <div class="col-md-12" style="padding-left: 30px;">
        <form class="form-inline">
            <div class="form-group">
                <div class="input-group">
                    <div class="input-group-addon">$</div>
                    <input type="text" class="form-control" id="stockCode" placeholder="代码" min="6" max="6">
                </div>
            </div>
            <button type="button" class="btn btn-primary" id="search_btn">查询</button>
            <button type="button" class="btn btn-success" id="add_btn">新增</button>
            <button type="button" class="btn btn-warning" id="refresh_data_btn">更新</button>
            <button type="button" class="btn btn-danger" id="del_btn">删除</button>
        </form>
    </div>
</div>

<table id="jqGrid"></table>
<div id="jqGridPager"></div>

</body>
</html>
<script type="text/javascript">
    $.jgrid.defaults.width = 780;
    $.jgrid.defaults.responsive = true;
    $.jgrid.defaults.styleUI = 'Bootstrap';
    $(document).ready(function () {

        $("#jqGrid").jqGrid({
            url:  "/stock/q",
            width: window.screen.availWidth - 20,
            multiselect: true,//复选框
            shrinkToFit: false,
            rownumbers: true,
            loadtext: '正在加载数据请稍后...',
            mtype: "GET",
            styleUI: 'Bootstrap',
            datatype: "json",
            colNames: ['代码', '名称','市场', '当前价格', '昨收','今日最高','今日最低', '涨幅', 'PE(动态)', 'PE(静态)', '市净率', '总市值', '净资产收益率', '每股净资产','上次分红率','分红日期', '所属行业', '主营业务'],
            colModel: [

                {label: 'code', name: 'code', width: 100, frozen: true},
                {label: 'name', name: 'name', width: 150, frozen: true},
                {label: 'type', name: 'type', width: 50, frozen: true},
                {label: 'price', name: 'price', width: 70, align: 'right', frozen: true},
                {label: 'yesterdayPrice', name: 'yesterdayPrice', width: 60, align: 'right'},

                {label: 'todayMax', name: 'todayMax', width: 70, align: 'right'},
                {label: 'todayMin', name: 'todayMin', width: 70, align: 'right'},

                {label: 'fluctuate', name: 'fluctuate', width: 70, align: 'right'},
                {label: 'ped', name: 'ped', width: 75, align: 'right'},
                {label: 'pes', name: 'pes', width: 75, align: 'right'},
                {label: 'pb', name: 'pb', width: 70, align: 'right'},

                {label: 'totalValue', name: 'totalValue', width: 80, align: 'right'},
                {label: 'roe', name: 'roe', width: 100, align: 'right'},
                {label: 'bvps', name: 'bvps', width: 90, align: 'right'},
                {label: 'dividend', name: 'dividend', width: 86, align: 'right'},
                {label: 'dividendDate', name: 'dividendDate', width: 90},
                {label: 'industry', name: 'industry', width: 200},
                {label: 'mainBusiness', name: 'mainBusiness', width: 650}
//                {label: 'sVersion', name: 'sVersion', width: 650}
            ],
            viewrecords: true,
            rowList: [10, 20, 30, 60],
            height: '700',
            rowNum: 30,
            pager: "#jqGridPager",
            gridComplete: function () {
                var ids = $("#jqGrid").getDataIDs();
                for (var i = 0; i < ids.length; i++) {
                    var rowData = $("#jqGrid").getRowData(ids[i]);
                    if (parseFloat(rowData.fluctuate) <= 0) {
                        $("#jqGrid").find('#' + ids[i]).find("td").css("color", "green");
                    }else{
                        $("#jqGrid").find('#' + ids[i]).find("td").css("color", "red");
                    }
                }
            },
            ondblClickRow: function(id){
                //双击行
                var rowData = $("#jqGrid").getRowData(id);
                window.open("/stock/his/"+rowData.code);
            }
        });
        $("#jqGrid").jqGrid("setFrozenColumns");
        /*function addCellAttr(rowId, val, rawObject, cm, rdata) {
            if (parseFloat(rawObject.fluctuate) < 0) {
                $($("#jqGrid" +"tr[id='"+ rowId +"']")).css("color", "green");
                return "style='color:green'";
            } else if (parseFloat(rawObject.fluctuate) > 0) {
                $($("#jqGrid" +"tr[id='"+ rowId +"']")).css("color", "red");
                return "style='color:red'";
            }
        }*/

    });
    /*$(window).resize(function(){
     $(window).unbind("onresize");
     $("#jqGrid").setGridHeight($(window).height() - 190);
     $(window).bind("onresize", this);
     });*/

    //刷新列表
    function reloadStock(){
        //此处可以添加对查询数据的合法验证
        var code = $("#stockCode").val();
        console.info(code);
        $("#jqGrid").jqGrid('setGridParam',{
            datatype:'json',
            postData:{'code':code},
            page:1
        }).trigger("reloadGrid");
    }

    $("#search_btn").click(function(){
        reloadStock();
    });

    /**
     * 刷新财务数据
     */
    $("#refresh_data_btn").click(function(){
        messageBox.showLoading('正在更新财务数据请稍后...');
        $.ajax({
            type: "POST",
            url: basepath + "/stock/refresh",
            success: function (data) {
                if (data == 'success') {
                    reloadStock();
                } else {
                    messageBox.error('提示', data);
                }
                messageBox.closeLoading();
            },
            error: function (data) { // 当提交失败时触发验证,如果验证通过则判断为其他问题
                messageBox.error('提示', '数据提交错误，请联系系统管理员.');
            }
        });
    });

    /**
     * 新增
     */
    $("#add_btn").click(function(){
        messageBox.showLoading('正在加载数据请稍后...');
        $.ajax({
            type: "POST",
            url: basepath + "/stock/add/" + $("#stockCode").val(),
            /*data: $("#form").serialize(),*/
            success: function (data) {
                messageBox.closeLoading();
                if (data == 'success') {
                    reloadStock();
                } else {
                    messageBox.error('提示', data);
                }

            },
            error: function (data) { // 当提交失败时触发验证,如果验证通过则判断为其他问题
                messageBox.error('提示', '数据提交错误，请联系系统管理员.');
            }
        });
    });

    $("#del_btn").click(function () {
        var ids = $("#jqGrid").jqGrid("getGridParam", "selarrrow");
        if (ids.length==0) {
            messageBox.notify("请选择要删除的股票!", "danger");
            return;
        }
        var codes=new Array();
        //遍历访问这个集合
        $(ids).each(function (index, id){
            //由id获得对应数据行
            var row = $("#jqGrid").jqGrid('getRowData', id);
            codes.push(row.sCode);
        })
        messageBox.confirm("是否删除选中的股票？", function (result) {
            messageBox.showLoading('正在处理请稍后...');
            $.ajax({
                type: "POST",
                url: basepath + "/stock/del",
                data: {codes: codes},
                success: function (data) {
                    messageBox.closeLoading();
                    if (data == 'success') {
                        reloadStock();
                    } else {
                        messageBox.error('提示', data);
                    }

                },
                error: function (data) { // 当提交失败时触发验证,如果验证通过则判断为其他问题
                    messageBox.error('提示', '数据提交错误，请联系系统管理员.');
                }
            });
        });


    });
</script>