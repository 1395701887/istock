<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>stock</title>
    <link href="https://cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
    <link href="//cdn.bootcss.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
    <!--<link href="https://cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">-->
    <link href="//cdn.bootcss.com/jquery.bootstrapvalidator/0.5.3/css/bootstrapValidator.min.css" rel="stylesheet">

    <link href="https://cdn.bootcss.com/bootstrap-table/1.11.1/bootstrap-table.css" rel="stylesheet">
    <link href="//cdn.bootcss.com/limonte-sweetalert2/6.6.5/sweetalert2.min.css" rel="stylesheet">
    <!--<script src="https://cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>-->
    <script src="//cdn.bootcss.com/jquery/2.2.0/jquery.min.js"></script>
    <script src="//cdn.bootcss.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/jquery.bootstrapvalidator/0.5.3/js/bootstrapValidator.min.js"></script>

    <script src="//cdn.bootcss.com/mouse0270-bootstrap-notify/3.1.7/bootstrap-notify.min.js"></script>
    <script src="//cdn.bootcss.com/bootstrap-table/1.11.1/bootstrap-table.js"></script>
    <script src="//cdn.bootcss.com/bootstrap-table/1.11.1/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="//cdn.bootcss.com/limonte-sweetalert2/6.6.5/sweetalert2.min.js"></script>
    <script src="/www/js/messageBox.js"></script>
    <!-- 调整表格列宽需要的插件 -->
   <!-- <script src="/www/plugs/bootstrap-table/extend/resizable/colResizable-1.5.min.js"></script>
    <script src="/www/plugs/bootstrap-table/extend/resizable/bootstrap-table-resizable.js"></script>-->
    <style>
        .stock-up{color: red;}
        .stock-down{color:#009900;}
    </style>
</head>
<body style="padding: 30px 0px 0px 0px;">



 <div class="col-md-10">
     <form id="stockForm"  class="form-inline">
         <div class="form-group">
             <input type="text" class="form-control" placeholder="股票代码" aria-describedby="basic-addon1" name="stock" id="stock">
         </div>
         <button class="btn btn-default"  type="button" id="queryBtn"><span class="glyphicon glyphicon-search"></span>&nbsp;查询</button>
         <button class="btn btn-default"  type="button" id="updateBtn"><span class="glyphicon glyphicon-refresh"></span>&nbsp;更新</button>
     </form>

 </div>
<br>
<table id="table"  class="table table-hover" data-toggle="table"
       data-side-pagination="server" data-pagination="true" data-checkbox-header="true"
       data-click-to-select="true" data-sort-stable="true" 	data-toolbar="#toolbar"
       data-pagination-loop="false" data-page-number="1" data-page-list="[10,20]"
       data-toolbar-align="right" data-sort-name="true"
>

    <thead>
    <tr>
        <th  data-field="index" data-formatter="indexFormatter" >序号</th>
        <th data-field="sCode" data-sortable="true">代码</th>
        <th data-field="sStockName" data-sortable="true">名称</th>
        <th data-field="sCurrentPrice" data-sortable="true" data-align="right">当前价格</th>
        <th data-field="sYesterdayPrice" data-sortable="true" data-align="right">昨收</th>
        <th data-field="sRangePrice" data-sortable="true" data-align="right">涨幅</th>
        <th data-field="sPeDynamic" data-sortable="true" data-align="right">市盈率(动态)</th>
        <th data-field="sPeStatic" data-sortable="true" data-align="right">市盈率(静态)</th>
        <th data-field="sPb" data-sortable="true" data-align="right">市净率</th>
        <th data-field="sTotalValue" data-sortable="true" data-align="right">总市值</th>
        <th data-field="sRoe" data-sortable="true" data-align="right">净资产收益率</th>
        <th data-field="sDividendRate" data-sortable="true" data-align="right">分红率</th>
        <th data-field="sDividendYear" data-sortable="true" data-align="right">分红年份</th>
        <th data-field="sIndustry" data-sortable="true" >所属行业</th>
        <th data-field="sMainBusiness" >主营业务</th>
        <th data-field="sVersion">s_version</th>
    </tr>
    </thead>
</table>
<script>
    function indexFormatter(value, row, index) {
        return index+1;
    }
    $('#table').bootstrapTable({
        url: "/stock/list",                     //请求后台的URL（*）
        pageSize: 20,
        //可供选择的每页的行数（*）
        pageList: [10, 20, 30, 100],
        queryParams: function (params) { //重写提交的数据
            return {
                // 这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                limit: params.limit, // 页面大小
                offset: params.offset, // 页码数 * 页面大小
                order: params.order, // 排序方式
                sort: params.sort, //排序的字段
                code:""
            };
        },
        cache: false,
        pagination: true,
        resizable: true,  //启动表格可拖动调整列宽效果,需要bootstrap-table-resizable插件已经其依赖的colResizable-1.5插件
        liveDrag: true,   // 表格拖动时的随动效果
        headerOnly: true,  // 设定拖动表头操作,能优化点击选行的体验
        clickToSelect: true,                //是否启用点击选中行
        rowStyle: function (row, index,value) {
            //这里有5个取值代表5中颜色['active', 'success', 'info', 'warning', 'danger'];
            var strclass = "";
            if(row.sRangePrice<0){
                strclass="stock-down";
            }else{
                strclass="stock-up";
            }
            row.sRangePrice=row.sRangePrice+"%";
            row.sTotalValue=row.sTotalValue+"亿";
            if(row.sRoe==-1){
                row.sRoe="--";
            }else{
                row.sRoe=row.sRoe+"%";
            }
            if(row.sDividendRate==-1){
                row.sDividendRate="--";
            }else{
                row.sDividendRate=row.sDividendRate+"%";
            }
            if(row.sDividendYear==-1){
                row.sDividendYear="--";
            }
            return { classes: strclass };
        }

    });


    function initValidator() {
        $('#stockForm').bootstrapValidator({
            message: 'This value is not valid',
            feedbackIcons: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            fields: {
                stock: {
                    validators: {
                        notEmpty: {
                            message: '代码不能为空'
                        },
                        regexp: {
                            regexp: /^[0-9]{6}$/,
                            message: '必须为6位有效数字'
                        }
                    }
                }
            }
        });
    }
    function update(){
        $.ajax({
            type: "POST",
            url: "/stock/refresh",
            success: function(data) {
                if(data == 'success') {
                    console.info("ok");
                    reload();
                }else {
                    messageBox.error('提示', data);
                }

            },
            error: function (data) { // 当提交失败时触发验证,如果验证通过则判断为其他问题
                messageBox.error('提示','数据提交错误，请联系系统管理员.');
            }
        });
    }
    $("#updateBtn").click(function() {
        update();
    });

    // 提交按钮事件
    $("#queryBtn").click(function() {
        //获取表单对象
        var $bootstrapValidator = $("#stockForm").data('bootstrapValidator');
        //手动触发验证
        $bootstrapValidator.validate();
        // 如果验证未通过,则不继续提交
        if (!$bootstrapValidator.isValid()) {
            return;
        }

        messageBox.showLoading('正在加载数据请稍后...');
        $.ajax({
            type: "POST",
            url: "/stock/add/"+$("#stock").val(),
            /*data: $("#form").serialize(),*/
            success: function(data) {
                messageBox.closeLoading();
                if(data == 'success') {
                    $('#stock').val("");
                    resetValidator();
                    reload();
                }else {
                    messageBox.error('提示', data);
                }

            },
            error: function (data) { // 当提交失败时触发验证,如果验证通过则判断为其他问题
                messageBox.error('提示','数据提交错误，请联系系统管理员.');
            }
        });
    });
    function reload() {
        // 表格自带的刷新方法
        $('#table').bootstrapTable('refresh',{
            url: '/stock/list'
        });
    }
    function resetValidator() {
        /*-------------------重置表单所有验证规则--------------------*/
        // 获取验证器
        var validator = $('#stockForm').data("bootstrapValidator");
        // 先销毁验证器
        validator.destroy();
        // 再重新初始化
        initValidator();
    }
    window.onload=function(){
        initValidator();
        window.setInterval("reload()",2000);
    }
</script>
</body>
</html>